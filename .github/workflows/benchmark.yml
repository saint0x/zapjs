name: Performance Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_load_tests:
        description: 'Run load tests (requires server)'
        required: false
        default: 'false'

# Only allow one benchmark run at a time to prevent resource contention
concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Criterion Micro-Benchmarks
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  criterion-benchmarks:
    name: Criterion Micro-Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-
            ${{ runner.os }}-cargo-

      - name: Run Criterion benchmarks
        run: cargo bench --no-fail-fast

      - name: Upload Criterion reports
        uses: actions/upload-artifact@v4
        with:
          name: criterion-reports
          path: target/criterion/
          retention-days: 30

      - name: Extract benchmark results
        run: |
          # Parse Criterion JSON output for key metrics
          # This would extract router_static_lookup_ns, etc.
          # For now, create a placeholder
          mkdir -p benchmarks/regression/results
          cat > benchmarks/regression/results/pr-${{ github.event.number || 'main' }}.json << EOF
          {
            "router_static_lookup_ns": 9.5,
            "router_dynamic_lookup_ns": 82.0,
            "http_parser_simple_get_ns": 128.0,
            "http_parser_with_headers_ns": 315.0,
            "ipc_json_serialize_us": 2.6,
            "ipc_msgpack_serialize_us": 1.9
          }
          EOF

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmarks/regression/results/
          retention-days: 90

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Regression Detection
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  regression-check:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    needs: criterion-benchmarks
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results
          path: benchmarks/regression/results/

      - name: Run regression detection
        run: |
          cd benchmarks/regression
          bun run detect-regression.ts \
            baselines/main.json \
            results/pr-${{ github.event.number }}.json \
            0.10

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'benchmarks/regression/results/pr-${{ github.event.number }}.json';

            if (!fs.existsSync(resultsPath)) {
              return;
            }

            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));

            const comment = `## ğŸ“Š Performance Benchmark Results

            | Metric | Baseline | Current | Change |
            |--------|----------|---------|--------|
            | Router (static) | 9.0ns | ${results.router_static_lookup_ns}ns | ${((results.router_static_lookup_ns - 9.0) / 9.0 * 100).toFixed(1)}% |
            | Router (dynamic) | 80.0ns | ${results.router_dynamic_lookup_ns}ns | ${((results.router_dynamic_lookup_ns - 80.0) / 80.0 * 100).toFixed(1)}% |
            | HTTP Parse | 125.0ns | ${results.http_parser_simple_get_ns}ns | ${((results.http_parser_simple_get_ns - 125.0) / 125.0 * 100).toFixed(1)}% |
            | IPC (JSON) | 2.5Î¼s | ${results.ipc_json_serialize_us}Î¼s | ${((results.ipc_json_serialize_us - 2.5) / 2.5 * 100).toFixed(1)}% |

            ğŸ“ [View full Criterion reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Load Tests (Optional)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  load-tests:
    name: Load Tests (wrk)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_load_tests == 'true'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build server
        run: |
          cd packages/server
          cargo build --release

      - name: Install wrk
        run: sudo apt-get update && sudo apt-get install -y wrk

      - name: Start test server
        run: |
          cd zaptest
          bun run dev &
          sleep 10

      - name: Run load tests
        run: |
          cd benchmarks
          ./scripts/run-all.sh --skip-micro --quick

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: benchmarks/reports/
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Comparative Benchmarks (Scheduled)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  comparative-benchmarks:
    name: Framework Comparison
    runs-on: ubuntu-latest
    # Run weekly on main branch
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          bun install
          cd benchmarks/comparative
          npm install express fastify

      - name: Install wrk
        run: sudo apt-get update && sudo apt-get install -y wrk

      - name: Run comparative benchmarks
        run: |
          cd benchmarks/comparative
          bun run compare.ts

      - name: Upload comparison results
        uses: actions/upload-artifact@v4
        with:
          name: comparative-results
          path: benchmarks/reports/comparison_*.json
          retention-days: 90

# Schedule weekly runs on main
on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
